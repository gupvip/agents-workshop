.PHONY: help install demo demo-stream database api memory interactive test clean setup venv

# Python interpreter
PYTHON := python3
VENV := venv
VENV_BIN := $(VENV)/bin
PIP := $(VENV_BIN)/pip
PYTHON_VENV := $(VENV_BIN)/python

# Default target
help:
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "  Incident Postmortem Generator - Makefile Commands"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "  Setup & Installation:"
	@echo "    make setup          - Complete setup (venv + deps + .env)"
	@echo "    make venv           - Create virtual environment only"
	@echo "    make install        - Install Python dependencies"
	@echo ""
	@echo "  Run Demos:"
	@echo "    make demo           - Run synthetic demo (batch mode)"
	@echo "    make demo-stream    - Run demo with streaming output"
	@echo "    make database       - Run database outage sample"
	@echo "    make api            - Run API timeout sample"
	@echo "    make memory         - Run memory leak sample"
	@echo "    make interactive    - Run in interactive mode"
	@echo ""
	@echo "  Testing & Maintenance:"
	@echo "    make test           - Run tests"
	@echo "    make clean          - Clean cache and remove venv"
	@echo ""
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""

# Create virtual environment
venv:
	@if [ ! -d "$(VENV)" ]; then \
		echo "ðŸ”§ Creating virtual environment..."; \
		$(PYTHON) -m venv $(VENV); \
		echo "âœ… Virtual environment created!"; \
	else \
		echo "âœ… Virtual environment already exists"; \
	fi

# Complete setup
setup: venv
	@echo "ðŸš€ Setting up Incident Postmortem Generator..."
	@if [ ! -f .env ]; then \
		echo "ðŸ“ Creating .env file from .env.example..."; \
		cp .env.example .env; \
		echo "âš ï¸  Please edit .env and add your API keys!"; \
	else \
		echo "âœ… .env file already exists"; \
	fi
	@echo "ðŸ“¦ Installing dependencies..."
	@$(PIP) install -r requirements.txt
	@echo "âœ… Setup complete! Run 'make demo' to test."

# Install dependencies
install: venv
	@echo "ðŸ“¦ Installing dependencies..."
	@$(PIP) install -r requirements.txt
	@echo "âœ… Installation complete!"

# Run synthetic demo
demo: venv
	@echo "ðŸš€ Running synthetic demo..."
	@$(PYTHON_VENV) main.py --demo

# Run demo with streaming
demo-stream: venv
	@echo "ðŸš€ Running demo with streaming..."
	@$(PYTHON_VENV) main.py --demo --stream

# Run database outage sample
database: venv
	@echo "ðŸ“Š Running database outage incident..."
	@$(PYTHON_VENV) main.py --file sample_incidents/database_outage.json --stream

# Run API timeout sample
api: venv
	@echo "âš¡ Running API timeout incident..."
	@$(PYTHON_VENV) main.py --file sample_incidents/api_timeout.json --stream

# Run memory leak sample
memory: venv
	@echo "ðŸ’¾ Running memory leak incident..."
	@$(PYTHON_VENV) main.py --file sample_incidents/memory_leak.json --stream

# Run interactive mode
interactive: venv
	@echo "ðŸŽ¯ Starting interactive mode..."
	@$(PYTHON_VENV) main.py --interactive

# Run tests
test: venv
	@echo "ðŸ§ª Running tests..."
	@$(VENV_BIN)/pytest test_postmortem.py -v

# Clean cache files and remove venv
clean:
	@echo "ðŸ§¹ Cleaning cache files and virtual environment..."
	@find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	@find . -type f -name "*.pyc" -delete 2>/dev/null || true
	@find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	@rm -rf $(VENV)
	@echo "âœ… Cleanup complete!"
